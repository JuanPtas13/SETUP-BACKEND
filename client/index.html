<!DOCTYPE html>
<html>
<head>
  <title>Detección en Vivo</title>
</head>
<body>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>

  <!-- Estado de manos -->
  <div id="handDetectionStatus" style="font-size: 24px; color: blue; margin-top: 10px;">
    Esperando detección de manos...
  </div>

  <!-- Estado de cara -->
  <div id="faceDetectionStatus" style="font-size: 24px; color: blue; margin-top: 10px;">
    Esperando detección de cara...
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    const handDetectionStatus = document.getElementById('handDetectionStatus');
    const faceDetectionStatus = document.getElementById('faceDetectionStatus');

    // Construir URL del WebSocket dinámicamente
    const wsUrl = `ws://${window.location.host}/ws`;
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log("✅ Conectado al WebSocket:", wsUrl);
    };

    ws.onerror = (err) => {
      console.error("❌ Error en WebSocket:", err);
    };

    ws.onclose = () => {
      console.warn("⚠️ WebSocket cerrado.");
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      // ----------------- Estado de manos -----------------
      if (data.manos && data.manos.length > 0) {
        handDetectionStatus.textContent = `Manos detectadas: ${data.manos.length}`;
        handDetectionStatus.style.color = 'green';
      } else {
        handDetectionStatus.textContent = "No se detectan manos.";
        handDetectionStatus.style.color = 'red';
      }

      // ----------------- Estado de cara -----------------
      if (data.cara && data.cara.length > 0) {
        faceDetectionStatus.textContent = "Cara detectada";
        faceDetectionStatus.style.color = 'green';
      } else {
        faceDetectionStatus.textContent = "No se detecta cara.";
        faceDetectionStatus.style.color = 'red';
      }
    };

    // Acceso a la cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream; })
      .catch(err => console.error(err));

    // Enviar frames al servidor cada 100ms (~10 FPS)
    setInterval(() => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL("image/jpeg");
      ws.send(dataURL);
    }, 100);
  </script>
</body>
</html>
