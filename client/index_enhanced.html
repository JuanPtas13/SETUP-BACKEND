<!DOCTYPE html>
<html>
<head>
  <title>Detecci√≥n en Vivo - Grabaci√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1420;
      --panel: #151b2b;
      --muted: #94a3b8;
      --text: #e6edf6;
      --brand: #6c5ce7;
      --brand-2: #8b80ff;
      --accent: #22d3ee;
      --card: #1b2235;
      --stroke: #263043;
      --radius: 16px;
      --gap: 20px;
      --success: #22c55e;
      --warning: #eab308;
      --error: #ef4444;
    }

    body {
      margin: 0;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: var(--gap);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    h1 {
      color: var(--accent);
      text-align: center;
      font-weight: 600;
      font-size: 24px;
      margin-bottom: 30px;
      letter-spacing: 0.5px;
    }

    h3 {
      color: var(--text);
      font-weight: 500;
      margin-bottom: 20px;
    }

    .main-content {
      display: flex;
      gap: 30px;
      align-items: flex-start;
      margin: var(--gap) 0;
    }

    .video-container {
      flex-shrink: 0;
    }

    #video {
      width: 480px;
      height: 360px;
      border: 2px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      background: var(--panel);
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .controls {
      background: var(--panel);
      border: 1px solid var(--stroke);
      padding: var(--gap);
      border-radius: var(--radius);
      margin: 0;
    }

    .control-group {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    label {
      display: inline-block;
      width: 120px;
      font-weight: 500;
      color: var(--text);
      font-size: 14px;
    }

    input, select {
      padding: 10px 12px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
    }

    button {
      padding: 12px 24px;
      margin: 10px 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
    }

    .start-btn {
      background: var(--success);
      color: white;
    }

    .start-btn:hover:not(:disabled) {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .stop-btn {
      background: var(--error);
      color: white;
    }

    .stop-btn:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-1px);
    }

    button:disabled {
      background: var(--muted);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .status {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 8px;
      font-weight: 500;
      text-align: center;
      font-size: 14px;
      letter-spacing: 0.5px;
    }

    .recording {
      background: rgba(234, 179, 8, 0.2);
      color: var(--warning);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .not-recording {
      background: rgba(148, 163, 184, 0.2);
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .detection-status {
      display: flex;
      gap: var(--gap);
      margin: 0;
    }

    .status-item {
      flex: 1;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .status-active {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
      border: 1px solid rgba(34, 197, 94, 0.3);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.1);
    }

    .status-inactive {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    #messages {
      margin-top: 15px;
      padding: 15px;
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      font-family: inherit;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      color: var(--muted);
      line-height: 1.4;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: var(--card);
    }

    #messages::-webkit-scrollbar-thumb {
      background: var(--stroke);
      border-radius: 3px;
    }

    /* Responsive breakpoints */
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
        gap: 15px;
      }

      .right-panel {
        max-width: none;
      }

      #video {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        height: auto;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 20px;
      }

      .main-content {
        gap: 20px;
      }

      .control-group {
        flex-wrap: wrap;
      }

      label {
        width: 100px;
        font-size: 13px;
      }

      input, select {
        min-width: 200px;
      }

      button {
        min-width: 140px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }

      .container {
        padding: 15px;
      }

      h1 {
        font-size: 18px;
      }

      .detection-status {
        flex-direction: column;
        gap: 10px;
      }

      .control-group {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      label {
        width: auto;
        text-align: left;
      }

      input, select, button {
        width: 100%;
        min-width: auto;
      }

      button {
        margin: 5px 0;
      }

      #messages {
        max-height: 150px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Detecci√≥n en Vivo - Grabaci√≥n</h1>

    <div class="main-content">
      <div class="video-container">
        <video id="video" autoplay></video>
        <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>
      </div>

      <div class="right-panel">
        <!-- Estado de detecci√≥n -->
        <div class="detection-status">
          <div class="status-item status-inactive" id="handStatus">
            <strong>Manos:</strong> No detectadas
          </div>
          <div class="status-item status-inactive" id="faceStatus">
            <strong>Cara:</strong> No detectada
          </div>
        </div>

        <!-- Terminal de mensajes -->
        <div id="messages"></div>

        <!-- Controles de grabaci√≥n -->
        <div class="controls">
          <h3>Controles de Grabaci√≥n</h3>

          <div class="control-group">
            <label>Tipo de datos:</label>
            <select id="dataType">
              <option value="hands">Manos</option>
              <option value="faces">Caras</option>
            </select>
          </div>

          <div class="control-group">
            <label>Etiqueta:</label>
            <input type="text" id="labelInput" placeholder="Ej: saludo, adi√≥s, etc." />
          </div>

          <div class="control-group">
            <button class="start-btn" id="startBtn" onclick="startRecording()">
              üü¢ Iniciar Grabaci√≥n
            </button>
            <button class="stop-btn" id="stopBtn" onclick="stopRecording()" disabled>
              üî¥ Detener Grabaci√≥n
            </button>
          </div>

          <div id="recordingStatus" class="status not-recording">
            Estado: No grabando
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const recordingStatus = document.getElementById('recordingStatus');
    const messages = document.getElementById('messages');
    const dataTypeSelect = document.getElementById('dataType');
    const labelInput = document.getElementById('labelInput');
    const handStatus = document.getElementById('handStatus');
    const faceStatus = document.getElementById('faceStatus');

    let ws;
    let isRecording = false;

    // Construir URL del WebSocket din√°micamente
    const wsUrl = `ws://${window.location.host}/ws`;

    function connectWebSocket() {
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        logMessage("‚úÖ Conectado al servidor WebSocket");
        updateButtons();
      };

      ws.onerror = (err) => {
        logMessage("‚ùå Error en WebSocket: " + err);
      };

      ws.onclose = () => {
        logMessage("‚ö† WebSocket cerrado. Reconectando...");
        setTimeout(connectWebSocket, 3000);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        updateDetectionStatus(data);
      };
    }

    function startRecording() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("No hay conexi√≥n con el servidor");
        return;
      }

      const label = labelInput.value.trim();
      if (!label) {
        alert("Por favor ingrese una etiqueta");
        return;
      }

      const dataType = dataTypeSelect.value;

      ws.send(`START_RECORDING:${label}:${dataType}`);
      isRecording = true;
      updateRecordingStatus();
      updateButtons();

      logMessage(`üü¢ Grabaci√≥n iniciada - Tipo: ${dataType}, Etiqueta: ${label}`);
    }

    function stopRecording() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        return;
      }

      ws.send("STOP_RECORDING");
      isRecording = false;
      updateRecordingStatus();
      updateButtons();

      logMessage("üî¥ Grabaci√≥n detenida");
    }

    function updateRecordingStatus() {
      if (isRecording) {
        recordingStatus.textContent = `Estado: Grabando (${dataTypeSelect.value})`;
        recordingStatus.className = "status recording";
      } else {
        recordingStatus.textContent = "Estado: No grabando";
        recordingStatus.className = "status not-recording";
      }
    }

    function updateButtons() {
      startBtn.disabled = isRecording || !ws || ws.readyState !== WebSocket.OPEN;
      stopBtn.disabled = !isRecording || !ws || ws.readyState !== WebSocket.OPEN;
    }

    function updateDetectionStatus(data) {
      // Actualizar estado de manos
      if (data.manos && data.manos.length > 0) {
        handStatus.innerHTML = `<strong>Manos:</strong> ${data.manos.length} detectadas`;
        handStatus.className = "status-item status-active";
      } else {
        handStatus.innerHTML = "<strong>Manos:</strong> No detectadas";
        handStatus.className = "status-item status-inactive";
      }

      // Actualizar estado de cara
      if (data.cara && data.cara.length > 0) {
        faceStatus.innerHTML = "<strong>Cara:</strong> Detectada";
        faceStatus.className = "status-item status-active";
      } else {
        faceStatus.innerHTML = "<strong>Cara:</strong> No detectada";
        faceStatus.className = "status-item status-inactive";
      }
    }

    function logMessage(message) {
      const timestamp = new Date().toLocaleTimeString();
      messages.innerHTML += `[${timestamp}] ${message}<br>`;
      messages.scrollTop = messages.scrollHeight;
    }

    // Acceso a la c√°mara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        logMessage("üìπ C√°mara activada");
      })
      .catch(err => {
        logMessage("‚ùå Error al acceder a la c√°mara: " + err);
      });

    // Enviar frames al servidor cada 100ms (~10 FPS)
    setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ctx.drawImage(video, 0, 0, 480, 360);
        const dataURL = canvas.toDataURL("image/jpeg");
        ws.send(dataURL);
      }
    }, 100);

    // Inicializar conexi√≥n
    connectWebSocket();
  </script>
</body>
</html>